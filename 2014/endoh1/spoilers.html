<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!-- START: two lines up starts content from: inc/top.default.html -->

<!-- END: this line ends content from: inc/top.default.html -->
<!-- START: this line starts content from: inc/head.default.html -->

<head>
<link rel="stylesheet" href="../../ioccc.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>The International Obfuscated C Code Contest</title>
<link rel="icon" type="image/x-icon" href="../../favicon.ico">
<meta name="description" content="spoilers.md for 2014/endoh1">
<meta name="keywords" content="IOCCC, 2014/endoh1, spoilers.md">
</head>

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->

<!-- END: this line ends content from: inc/head.default.html -->

<!-- -->
<!-- This web page was formed via the tool: bin/gen-other-html.sh -->
<!-- The content of main section of this web page came from: 2014/endoh1/spoilers.md -->
<!-- -->

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->

<!-- Markdown content was converted into HTML via the tool: bin/md2html.sh -->

<!-- START: this line starts content from: inc/body.default.html -->

<body>

<!-- END: this line ends content from: inc/body.default.html -->
<!-- START: this line starts content from: inc/topbar.default.html -->

<div class="theader">
  <nav class="topbar">
    <div class="container">
      <div class="logo">
        <a href="../../index.html" class="logo-link">
          IOCCC
       </a>
      </div>

      <div class="topbar-items">
        <div class="item">
          <span class="item-header">
            Entries
          </span>

          <div class="sub-item">
            <div class="outfit-font">
              <a href="../../years.html" class="sub-item-link">
                Winning Entries
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../authors.html" class="sub-item-link">
                Winning Authors
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../location.html" class="sub-item-link">
                Location of winning authors
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../bugs.html" class="sub-item-link">
                Bugs and (mis)features
              </a>
            </div>
          </div>
        </div>

        <div class="item">
          <span class="item-header">
            Status
          </span>

          <div class="sub-item">
            <div class="outfit-font">
              <a href="../../news.html" class="sub-item-link">
                IOCCC News
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../status.html" class="sub-item-link">
                Contest status
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../next/index.html" class="sub-item-link">
                Rules and Guidelines
              </a>
            </div>
          </div>
        </div>

        <div class="item">
          <span class="item-header">
            FAQ
          </span>

          <div class="sub-item">
            <div class="outfit-font">
              <a href="../../faq.html" class="sub-item-link">
                  FAQ
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../faq.html#submit" class="sub-item-link">
                How to enter the IOCCC
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../faq.html#fix_an_entry" class="sub-item-link">
                Fixing IOCCC entries
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../faq.html#fix_web_site" class="sub-item-link">
                Fixing the website
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../faq.html#fix_author" class="sub-item-link">
                Updating author info
              </a>
            </div>
          </div>
        </div>

        <div class="item">
          <span class="item-header">
            About
          </span>

          <div class="sub-item">
            <div class="outfit-font">
              <a href="../../index.html" class="sub-item-link">
                IOCCC Home
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../judges.html" class="sub-item-link">
                The IOCCC Judges
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../contact.html" class="sub-item-link">
                Contacting the IOCCC
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../thanks-for-help.html" class="sub-item-link">
                Thanks for the help
              </a>
            </div>

            <div class="outfit-font">
              <a href="../../markdown.html" class="sub-item-link">
                IOCCC markdown guidelines
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="header-mobile-menu">
    <noscript>
      <a href="../../nojs-menu.html" class="topbar-js-label">
        Please Enable JavaScript
      </a>
    </noscript>

    <button id="header-open-menu-button" class="topbar-mobile-menu">
      <img
        src="../../png/hamburger-icon-open.png"
        alt="hamburger style menu icon - open state"
        width=48
        height=48>
    </button>

    <button id="header-close-menu-button" class="hide-content">
      <img
        src="../../png/hamburger-icon-closed.png"
        alt="hamburger style menu icon - closed state"
        width=48
        height=48>
    </button>

    <div id="mobile-menu-panel" class="hide-content">
      <div class="mobile-menu-container">

        <div class="mobile-menu-wrapper">
          <div class="mobile-menu-item">
            Entries
          </div>
          <div class="mobile-submenu-wrapper">

            <a class="mobile-submenu-item" href="../../years.html">
              Winning Entries
            </a>

            <a class="mobile-submenu-item" href="../../authors.html">
              Authors of winning IOCCC entries
            </a>

            <a class="mobile-submenu-item" href="../../location.html">
              Location of authors
            </a>

            <a class="mobile-submenu-item" href="../../bugs.html">
              Bugs and (mis)features
            </a>

          </div>
        </div>

        <div class="mobile-menu-wrapper">

          <div class="mobile-menu-item">
            Status
          </div>
          <div class="mobile-submenu-wrapper">

            <a class="mobile-submenu-item" href="../../status.html">
              Contest status
            </a>

            <a class="mobile-submenu-item" href="../../next/index.html">
              Rules and Guidelines
            </a>

            <a class="mobile-submenu-item" href="../../news.html">
              IOCCC News
            </a>

          </div>
        </div>

        <div class="mobile-menu-wrapper">
          <div class="mobile-menu-item">
            FAQ
          </div>
          <div class="mobile-submenu-wrapper">

            <a class="mobile-submenu-item" href="../../faq.html">
              Frequently Asked Questions
            </a>

            <a class="mobile-submenu-item" href="../../faq.html#submit">
              How to enter the IOCCC
            </a>

            <a class="mobile-submenu-item" href="../../faq.html#fix_an_entry">
              Fixing IOCCC entries
            </a>

            <a class="mobile-submenu-item" href="../../faq.html#fix_web_site">
              Fixing the website
            </a>

            <a class="mobile-submenu-item" href="../../faq.html#fix_author">
              Fixing author info
            </a>

          </div>
        </div>

        <div class="mobile-menu-wrapper">
          <div class="mobile-menu-item">
            About
          </div>
          <div class="mobile-submenu-wrapper">

            <a class="mobile-submenu-item" href="../../index.html">
              IOCCC Home
            </a>

            <a class="mobile-submenu-item" href="../../judges.html">
              The IOCCC Judges
            </a>

            <a class="mobile-submenu-item" href="../../contact.html">
              Contacting the IOCCC
            </a>

            <a class="mobile-submenu-item" href="../../thanks-for-help.html">
              Thanks for the help
            </a>

          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
  var headerOpenMenuButton = document.getElementById("header-open-menu-button");
  var headerCloseMenuButton = document.getElementById("header-close-menu-button");
  var mobileMenuPanel = document.getElementById("mobile-menu-panel");

  headerOpenMenuButton.addEventListener("click", () => {
    headerOpenMenuButton.classList.remove("topbar-mobile-menu");
    headerOpenMenuButton.classList.add("hide-content");

    headerCloseMenuButton.classList.remove("hide-content");
    headerCloseMenuButton.classList.add("topbar-mobile-menu");

    mobileMenuPanel.classList.remove("hide-content");
    mobileMenuPanel.classList.add("topbar-mobile-panel");
  });

  headerCloseMenuButton.addEventListener("click", () => {
    headerCloseMenuButton.classList.remove("topbar-mobile-menu");
    headerCloseMenuButton.classList.add("hide-content");

    mobileMenuPanel.classList.add("hide-content");
    mobileMenuPanel.classList.remove("topbar-mobile-panel");

    headerOpenMenuButton.classList.add("topbar-mobile-menu");
    headerOpenMenuButton.classList.remove("hide-content");
  });
</script>

<!-- END: this line ends content from: inc/topbar.default.html -->
<!-- START: this line starts content from: inc/header.default.html -->

<div class="header">
  <a href="../../2011/zucker/index.html">
      <img src="../../png/ioccc.png"
	   alt="IOCCC image by Matt Zucker"
	   width=300 
	   height=110>
  </a>
  <h1>The International Obfuscated C Code Contest</h1>
  <h2>spoilers.html for 2014/endoh1</h2>
</div>

<!-- END: this line ends content from: inc/header.default.html -->
<!-- START: this line starts content from: inc/navbar.up2index.html -->

<div class="navbar">
  <a class="Left" href="index.html">&uarr; jump to index.html &uarr;</a>
  <a class="Right" href="https://validator.w3.org/nu/?doc=https%3A%2F%2Fioccc-src.github.io%2Ftemp-test-ioccc%2F2014%2Fendoh1%2Fspoilers.html">&#x2713;</a>
</div>

<!-- END: this line ends content from: inc/navbar.up2index.html -->
<!-- START: this line starts content from: inc/before-content.default.html -->

    <div class="content" id="content">

<!-- END: this line ends content from: inc/before-content.default.html -->
<!-- START: this line starts content for HTML phase 21 by: bin/pandoc-wrapper.sh via bin/md2html.sh -->

<!-- BEFORE: 1st line of markdown file: 2014/endoh1/spoilers.md -->
<h1 id="quiner-code-generator">Q(uine)R code generator</h1>
<h2 id="what-is-difficult">What is difficult?</h2>
<p>As you may know, QR code (specification: ISO/IEC 18004) is quite complex. It
requires a bit stream, Reed-Solomon codes, BCH codes, data relocation, big (and
irregular!) numerical tables, human-oriented pattern arrangement (difficult to
implement by a small program), etc.</p>
<p>On the other hand, a quine has a big restriction: it needs to have two copies of
the program!</p>
<p>Do you think that it is possible to write QR code encoder in C within <em>1kB</em>?</p>
<h2 id="how-did-i-achieve-that">How did I achieve that?</h2>
<p>It is known that we can mitigate the quine restriction by <code>eval</code>.
For example, this is a quine written in Ruby:</p>
<pre><code>    eval s=&quot;print &#39;eval s=&#39;; p s&quot;</code></pre>
<p>Note that <code>print</code> appears just once in the program.</p>
<p>To emulate this approach in C, I adopted the following structure.</p>
<pre><code>    char s[]=&quot;&lt;main code&gt;int main() { &lt;VM code&gt; }&quot;;
    int main() { &lt;VM code&gt;; }</code></pre>
<ul>
<li><code>&lt;VM code&gt;</code> : An own VM implementation (written in C) that executes the main
code.</li>
<li><code>&lt;main code&gt;</code> : An object code of quine and QR code encoder (written in the
assembly language of the VM).</li>
</ul>
<p><code>&lt;main code&gt;</code> (about 1100 bytes) appears once and <code>&lt;VM code&gt;</code> (about 450 bytes)
appears twice. So the whole code is about 1100 + 450 * 2 = 2000 bytes. Hooray!</p>
<h2 id="what-sort-of-vm-is-that">What sort of VM is that?</h2>
<p>The VM is a kind of stack machine which makes the object code compact. The
instruction set is carefully selected to minimize the sizes of both <code>&lt;main code&gt;</code> and <code>&lt;VM code&gt;</code>.</p>
<ul>
<li>21 integer registers access
<ul>
<li>read, write, inc-and-read, dec-and-read</li>
</ul></li>
<li>Binary operations
<ul>
<li>add, sub, mul, div, mod, xor, less than, equal, right shift</li>
</ul></li>
<li>Stack operation
<ul>
<li>push (an immediate value)</li>
</ul></li>
<li>Heap access
<ul>
<li>load, store</li>
</ul></li>
<li>If-Then-Else</li>
<li>While-Loop</li>
<li>Misc.
<ul>
<li>putchar, exit</li>
</ul></li>
</ul>
<p>The instructions have variable lengths, but many of them are represented as one
printable character. (See <a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/machine.rb">machine.rb</a> and
<a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/assemble.rb">assemble.rb</a> in detail.) The mapping between instructions and
characters is also carefully designed to minimize <code>&lt;VM code&gt;</code>, which makes the
resulted program non-human-readable.</p>
<h2 id="how-did-i-create-the-main-code">How did I create the main code?</h2>
<p>It is too tedious to write the machine language directly. So I wrote the source
code in Ruby syntax and created a Ruby-to-VM compiler that involves alpha
renaming and automatic register allocation only for this purpose.</p>
<ul>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/src.rb">src.rb</a>: the source code of QR code encoder written in Ruby syntax.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/vm.c">vm.c</a>: the source code of the VM.</li>
</ul>
<p>The compiler tool chain is the following.</p>
<pre><code>    src.rb              interp.c
      |                   |
      | [parse.rb]        |
      V                   |
    ast.txt               |
      |                   |
      | [serialize.rb]    |
      V                   |
    seq.txt               |
      |                   |
      | [alpha.rb]        |
      V                   |
    alpha.txt             |
      |                   |
      | [register.rb]     |
      V                   |
    reg.txt               |
      |                   |
      | [assemble.rb]     |
      V                   |
    raw.txt               |
      |                   |
      +---------+---------+
                |
                | [link.rb]
                V
              main.c
                |
                | [gen-prog.c]
                V
              prog.c</code></pre>
<ul>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/parse.rb">parse.rb</a> converts Ruby to AST.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/serialize.rb">serialize.rb</a> converts AST to intermediate instruction sequence.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/alpha.rb">alpha.rb</a> applies “alpha-renaming” to the instruction sequence.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/register.rb">register.rb</a> applies “register allocation”.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/assemble.rb">assemble.rb</a> converts the sequence to the final stack-machine instructions.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/vm.c">vm.c</a> is an implementation of the VM.</li>
<li><a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/link.rb">link.rb</a> generates <code>main.c</code> by linking the instructions and interpreter source.</li>
<li><code>gen-prog.rb</code> generates <a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/prog.c">prog.c</a> based on <code>main.c</code>.</li>
</ul>
<p>You can run the process by <code>rake</code> command. <code>ruby-minisat</code> gem is needed.</p>
<pre><code>    $ gem install ruby-minisat
    $ rake</code></pre>
<h2 id="tools">Tools</h2>
<p>I checked that the following QR code readers can read the output of my program.</p>
<ul>
<li>Linux: <a href="http://zbar.sourceforge.net/">ZBar bar code reader</a>.</li>
</ul>
<h3 id="a-note-from-the-judges-in-2023">A note from the judges in 2023:</h3>
<p>The author also tested an Android app called Barcode Scanner which used to be
found at
<code>https://play.google.com/store/apps/details?id=com.google.zxing.client.android</code>
but it appears to no longer exist.</p>
<p>You can use <a href="https://github.com/ioccc-src/temp-test-ioccc/blob/master/2014/endoh1/tool.rb">tool.rb</a> to convert the output to a png file.</p>
<pre><code>    ./main Hello | ruby tool.rb &gt; hello.png

    $ zbarimg -q hello.png
    QR-Code:Hello

    $ ruby tool.rb prog.c
    $ ruby tool.rb prog.c | ruby tool.rb</code></pre>
<h2 id="limitations">Limitations</h2>
<ul>
<li>QR code error correction level is fixed to L (Low).</li>
<li>It supports only byte mode (not numeric, alphanumeric, kanji mode…).</li>
<li>The mask pattern is fixed to 4.</li>
<li>The mask is not applied to the remained bits.</li>
</ul>
<hr style="width:10%;text-align:left;margin-left:0">
<p>Jump to: <a href="#">top</a></p>
<!--

    Copyright © 1984-2024 by Landon Curt Noll. All Rights Reserved.

    You are free to share and adapt this file under the terms of this license:

        Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)

    For more information, see:

        https://creativecommons.org/licenses/by-sa/4.0/

-->
<!-- AFTER: last line of markdown file: 2014/endoh1/spoilers.md -->

<!-- END: this line ends content for HTML phase 21 by: bin/pandoc-wrapper.sh via bin/md2html.sh -->
<!-- START: this line starts content from: inc/after-content.default.html -->

    </div>

<!-- END: this line ends content from: inc/after-content.default.html -->
<!-- START: this line starts content from: inc/footer.default.html -->

<!--

    Copyright © 1984-2024 by Landon Curt Noll. All Rights Reserved.

    You are free to share and adapt this file under the terms of this license:

        Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)

    For more information, see:

        https://creativecommons.org/licenses/by-sa/4.0/

-->

<div class="footer">

    <div id="copyright"><h3>Copyright &copy; 1984-2024 by Landon Curt Noll:
	<a href="https://creativecommons.org/faq/#what-does-some-rights-reserved-mean"
	   target="_blank"
	   rel="license noopener noreferrer">Some Rights Reserved</a></h3>
	<p>
	This work is <b>licensed by Landon Curt Noll</b> under
	  <b><a href="https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1"
	     target="_blank"
	     rel="license noopener noreferrer"
	     style="display:inline-block;">CC BY-SA 4.0</a></b>.
	  <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
	       src="../../png/cc.png"
	       alt="cc inside circle symbol">
	  <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
	       src="../../png/by.png"
	       alt="person inside circle symbol">
	  <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
	       src="../../png/sa.png"
	       alt="arrow looping back on itself inside circle symbol"><br>
	You should <b>carefully review</b> the
	    <b><a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode.en"
		target="_blank"
		rel="license noopener noreferrer">CC BY-SA 4.0 LEGAL CODE</a></b>
	    before using the licensed material.<br>
	You may wish to review the
	    <b><a href="../../license.html"
		target="_blank"
		rel="license noopener noreferrer">highlights of some of the key features and terms</a></b>
	    of <b>CC BY-SA 4.0</b>.<br>
	</p>
    </div>

    <div id="coda"><h3>Coda</h3>
	<p>
	<a href="https://validator.w3.org/nu/?doc=https%3A%2F%2Fioccc-src.github.io%2Ftemp-test-ioccc%2F2014%2Fendoh1%2Fspoilers.html" rel="nofollow">Nu HTML check this web page</a><br>
	<a href="#top">Jump to top</a> <a href="#content">Jump to Content</a>
	</p>
    </div>

</div>

<!-- END: this line ends content from: inc/footer.default.html -->
<!-- START: this line starts content from: inc/bottom.default.html -->

</body>
</html>

<!-- END: this line ends content from: inc/bottom.default.html -->
