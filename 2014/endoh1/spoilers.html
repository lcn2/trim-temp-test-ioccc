<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!-- START: two lines up starts content from: inc/top.default.html -->

<!-- END: this line ends content from: inc/top.default.html -->
<!-- START: this line starts content from: inc/head.default.html -->

<head>
<link rel="stylesheet" href="../../ioccc.css">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>The International Obfuscated C Code Contest</title>
<link rel="icon" type="image/x-icon" href="../../favicon.ico">
<meta name="description" content="spoilers.md for 2014/endoh1">
<meta name="keywords" content="IOCCC, 2014/endoh1, spoilers.md">
</head>

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!! DO NOT MODIFY THIS FILE - This file is generated by a tool !!! -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->

<!-- END: this line ends content from: inc/head.default.html -->

<!-- -->
<!-- This web page was formed via the tool: bin/gen-other-html.sh -->
<!-- The content of main section of this web page came from: 2014/endoh1/spoilers.md -->
<!-- -->

<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!! Do not modify this web page, instead modify the file: 2014/endoh1/spoilers.md !!! -->
<!-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! -->

<!-- Markdown content was converted into HTML via the tool: bin/md2html.sh -->

<!-- START: this line starts content from: inc/body.default.html -->

<body>

<!-- END: this line ends content from: inc/body.default.html -->
<!-- START: this line starts content from: inc/header.default.html -->

<div class="header">
  <img src="../../png/ioccc.png" alt="IOCCC image by Matt Zucker" width=300 height=110>
  <h1>The International Obfuscated C Code Contest</h1>
  <h2>spoilers.md for 2014/endoh1</h2>
</div>

<!-- END: this line ends content from: inc/header.default.html -->
<!-- START: this line starts content from: inc/topnav.up2index.html -->

<div class="topnav">
  <a class="Left" href="index.html">&uarr; jump to index.html &uarr;</a>
</div>

<!-- END: this line ends content from: inc/topnav.up2index.html -->
<!-- START: this line starts content from: inc/begin-row.default.html -->

<div class="row">

<!-- END: this line ends content from: inc/begin-row.default.html -->
<!-- START: this line starts content from: inc/begin-leftcolumn.default.html -->

  <div class="leftcolumn">

<!-- END: this line ends content from: inc/begin-leftcolumn.default.html -->
<!-- START: this line starts content from: inc/sidenav.default.html -->

    <div class="sidenav">
      <a href="#content">Jump to contents</a>
    </div>
    <hr>
    <div class="sidenav">
      <a href="../../index.html">IOCCC Home</a>
      <a href="../../years.html">Winning Entries</a>
      <a href="../../authors.html">People who have won</a>
      <a href="../../location.html">Location of authors</a>
    </div>
    <hr>
    <div class="sidenav">
      <a href="../../news.html">IOCCC News</a>
      <a href="../../status.html">Contest status</a>
      <a href="../../faq.html#submit">How to enter the IOCCC</a>
      <a href="../../faq.html">FAQ</a>
    </div>
    <hr>
    <div class="sidenav">
      <a href="../../bugs.html">Bugs &amp; (mis)features</a>
      <a href="../../faq.html#fix_an_entry">Fixing IOCCC entries</a>
      <a href="../../faq.html#fix_web_site">Fixing the web site</a>
      <a href="../../faq.html#fix_author">Fixing author info</a>
      <a href="../../thanks-for-help.html">Thanks for the help</a>
    </div>
    <hr>
    <div class="sidenav">
      <a href="../../judges.html">The IOCCC Judges</a>
      <a href="../../contact.html">Contacting the IOCCC</a>
    </div>
    <hr>
    <div class="sidenav">
      <a href="#top">Jump to top</a>
    </div>

<!-- END: this line ends content from: inc/sidenav.default.html -->
<!-- START: this line starts content from: inc/end-leftcolumn.default.html -->

  </div>

<!-- END: this line ends content from: inc/end-leftcolumn.default.html -->
<!-- START: this line starts content from: inc/begin-rightcolumn.default.html -->

  <div class="rightcolumn">

<!-- END: this line ends content from: inc/begin-rightcolumn.default.html -->
<!-- START: this line starts content from: inc/before-content.default.html -->

    <a name="content"></a>

<!-- END: this line ends content from: inc/before-content.default.html -->
<!-- START: this line starts content for HTML phase 21 by: bin/pandoc-wrapper.sh via bin/md2html.sh -->

<h1 id="quiner-code-generator">Q(uine)R code generator</h1>
<h2 id="what-is-difficult">What is difficult?</h2>
<p>As you may know, QR code (specification: ISO/IEC 18004) is quite complex. It
requires a bit stream, Reed-Solomon codes, BCH codes, data relocation, big (and
irregular!) numerical tables, human-oriented pattern arrangement (difficult to
implement by a small program), etc.</p>
<p>On the other hand, a quine has a big restriction: it needs to have two copies of
the program!</p>
<p>Do you think that it is possible to write QR code encoder in C within <em>1kB</em>?</p>
<h2 id="how-did-i-achieve-that">How did I achieve that?</h2>
<p>It is known that we can mitigate the quine restriction by <code>eval</code>.
For example, this is a quine written in Ruby:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span> s<span class="kw">=</span><span class="st">&quot;print &#39;eval s=&#39;; p s&quot;</span></span></code></pre></div>
<p>Note that <code>print</code> appears just once in the program.</p>
<p>To emulate this approach in C, I adopted the following structure.</p>
<pre><code>char s[]=&quot;&lt;main code&gt;int main() { &lt;VM code&gt; }&quot;;
int main() { &lt;VM code&gt;; }</code></pre>
<ul>
<li><code>&lt;VM code&gt;</code> : An own VM implementation (written in C) that executes the main
code.</li>
<li><code>&lt;main code&gt;</code> : An object code of quine and QR code encoder (written in the
assembly language of the VM).</li>
</ul>
<p><code>&lt;main code&gt;</code> (about 1100 bytes) appears once and <code>&lt;VM code&gt;</code> (about 450 bytes)
appears twice. So the whole code is about 1100 + 450 * 2 = 2000 bytes. Hooray!</p>
<h2 id="what-sort-of-vm-is-that">What sort of VM is that?</h2>
<p>The VM is a kind of stack machine which makes the object code compact. The
instruction set is carefully selected to minimize the sizes of both <code>&lt;main code&gt;</code> and <code>&lt;VM code&gt;</code>.</p>
<ul>
<li>21 integer registers access
<ul>
<li>read, write, inc-and-read, dec-and-read</li>
</ul></li>
<li>Binary operations
<ul>
<li>add, sub, mul, div, mod, xor, less than, equal, right shift</li>
</ul></li>
<li>Stack operation
<ul>
<li>push (an immediate value)</li>
</ul></li>
<li>Heap access
<ul>
<li>load, store</li>
</ul></li>
<li>If-Then-Else</li>
<li>While-Loop</li>
<li>Misc.
<ul>
<li>putchar, exit</li>
</ul></li>
</ul>
<p>The instructions have variable lengths, but many of them are represented as one
printable character. (See <a href="machine.rb">machine.rb</a> and
<a href="assemble.rb">assemble.rb</a> in detail.) The mapping between instructions and
characters is also carefully designed to minimize <code>&lt;VM code&gt;</code>, which makes the
resulted program non-human-readable.</p>
<h2 id="how-did-i-create-the-main-code">How did I create the main code?</h2>
<p>It is too tedious to write the machine language directly. So I wrote the source
code in Ruby syntax and created a Ruby-to-VM compiler that involves alpha
renaming and automatic register allocation only for this purpose.</p>
<ul>
<li><a href="src.rb">src.rb</a>: the source code of QR code encoder written in Ruby syntax.</li>
<li><a href="vm.c">vm.c</a>: the source code of the VM.</li>
</ul>
<p>The compiler tool chain is the following.</p>
<pre><code>src.rb              interp.c
  |                   |
  | [parse.rb]        |
  V                   |
ast.txt               |
  |                   |
  | [serialize.rb]    |
  V                   |
seq.txt               |
  |                   |
  | [alpha.rb]        |
  V                   |
alpha.txt             |
  |                   |
  | [register.rb]     |
  V                   |
reg.txt               |
  |                   |
  | [assemble.rb]     |
  V                   |
raw.txt               |
  |                   |
  +---------+---------+
            |
            | [link.rb]
            V
          main.c
            |
            | [gen-prog.c]
            V
          prog.c</code></pre>
<ul>
<li><a href="parse.rb">parse.rb</a> converts Ruby to AST.</li>
<li><a href="serialize.rb">serialize.rb</a> converts AST to intermediate instruction sequence.</li>
<li><a href="alpha.rb">alpha.rb</a> applies “alpha-renaming” to the instruction sequence.</li>
<li><a href="register.rb">register.rb</a> applies “register allocation”.</li>
<li><a href="assemble.rb">assemble.rb</a> converts the sequence to the final stack-machine instructions.</li>
<li><a href="interp.c">interp.c</a> is an implementation of the VM.</li>
<li><a href="link.rb">link.rb</a> generates <code>main.c</code> by linking the instructions and interpreter source.</li>
<li><a href="gen-prog.c">gen-prog.c</a> generates <a href="prog.c">prog.c</a> based on <code>main.c</code>.</li>
</ul>
<p>You can run the process by <code>rake</code> command. <code>ruby-minisat</code> gem is needed.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gem install ruby-minisat</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> rake</span></code></pre></div>
<h2 id="tools">Tools</h2>
<p>I checked that the following QR code readers can read the output of my program.</p>
<ul>
<li>Linux: <a href="http://zbar.sourceforge.net/">ZBar bar code reader</a>.</li>
</ul>
<h3 id="a-note-from-the-judges-in-2023">A note from the judges in 2023:</h3>
<p>The author also tested an Android app called Barcode Scanner which used to be
found at
<code>https://play.google.com/store/apps/details?id=com.google.zxing.client.android</code>
but it appears to no longer exist.</p>
<p>You can use <a href="tool.rb">tool.rb</a> to convert the output to a png file.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./main</span> Hello <span class="kw">|</span> <span class="ex">ruby</span> tool.rb <span class="op">&gt;</span> hello.png</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> zbarimg <span class="at">-q</span> hello.png</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">QR-Code:Hello</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ruby tool.rb prog.c</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ruby tool.rb prog.c <span class="kw">|</span> <span class="ex">ruby</span> tool.rb</span></code></pre></div>
<h2 id="limitations">Limitations</h2>
<ul>
<li>QR code error correction level is fixed to L (Low).</li>
<li>It supports only byte mode (not numeric, alphanumeric, kanji mode…).</li>
<li>The mask pattern is fixed to 4.</li>
<li>The mask is not applied to the remained bits.</li>
</ul>
<!--

    Copyright © 1984-2024 by Landon Curt Noll. All Rights Reserved.

    You are free to share and adapt this file under the terms of this license:

        Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)

    For more information, see:

        https://creativecommons.org/licenses/by-sa/4.0/

-->

<!-- END: this line ends content for HTML phase 21 by: bin/pandoc-wrapper.sh via bin/md2html.sh -->
<!-- START: this line starts content from: inc/after-content.default.html -->

<!-- END: this line ends content from: inc/after-content.default.html -->
<!-- START: this line starts content from: inc/end-rightcolumn.default.html -->

  </div>

<!-- END: this line ends content from: inc/end-rightcolumn.default.html -->
<!-- START: this line starts content from: inc/end-row.default.html -->

</div>

<!-- END: this line ends content from: inc/end-row.default.html -->
<!-- START: this line starts content from: inc/footer.default.html -->

<!--

    Copyright © 1984-2024 by Landon Curt Noll. All Rights Reserved.

    You are free to share and adapt this file under the terms of this license:

	Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)

    For more information, see:

	https://creativecommons.org/licenses/by-sa/4.0/

-->

<div class="footer">
  <h2>Copyright and CC BY-SA 4.0 License</h2>
  <p>This file and web page is:</p>
  <blockquote><b>Copyright &copy; 1984-2024 by Landon Curt Noll. All Rights Reserved.</b></blockquote>
  <p>You are free to share and adapt this file under the terms of this license:</p>
  <blockquote><b>Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)</b></blockquote>
  <p>For more information, see:</p>
  <blockquote><a
    href="https://creativecommons.org/licenses/by-sa/4.0/">https://creativecommons.org/licenses/by-sa/4.0/</a></blockquote>
  <h2>Coda</h2>
  <p><a href="https://validator.w3.org/nu/?doc=#">Nu HTML check this web page</a></p>
  <p><a href="#top">Jump to top</a> <a href="#content">Jump to Content</a> <a href="#inventory">Jump to Inventory</a></p>
</div>

<!-- END: this line ends content from: inc/footer.default.html -->
<!-- START: this line starts content from: inc/bottom.default.html -->

</body>
</html>

<!-- END: this line ends content from: inc/bottom.default.html -->
